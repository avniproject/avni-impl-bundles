{
  "name" : "Child Home Visit",
  "uuid" : "ad1c49aa-6297-4e42-99f1-ede058cc2872",
  "formType" : "ProgramEncounter",
  "formElementGroups" : [ {
    "uuid" : "d137a1c0-7eb6-4fdd-bf02-bf1a42b37823",
    "name" : "Details",
    "displayOrder" : 1.0,
    "formElements" : [ {
      "name" : "Has the child recovered?",
      "uuid" : "222779f6-22df-4e12-81c2-d3e202522a20",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Has the child recovered?",
        "uuid" : "c3536382-a218-4ed9-bb7e-12d4d12bbf93",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "Yes",
          "uuid" : "8ebbf088-f292-483e-9084-7de919ce67b7",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 0.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "No",
          "uuid" : "a77bd700-1409-4d52-93bc-9fe32c0e169b",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 1.0,
      "type" : "SingleSelect",
      "voided" : true,
      "mandatory" : true
    }, {
      "name" : "Is the child taking medicinces on time",
      "uuid" : "af2151d2-cf3b-47bd-a497-158be1646d5b",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Is the child taking medicinces on time",
        "uuid" : "c293c2fb-cd04-4df5-a180-6323f926c53d",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "No",
          "uuid" : "a77bd700-1409-4d52-93bc-9fe32c0e169b",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Yes",
          "uuid" : "8ebbf088-f292-483e-9084-7de919ce67b7",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 0.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 2.0,
      "type" : "SingleSelect",
      "voided" : true,
      "mandatory" : true
    }, {
      "name" : "Weight",
      "uuid" : "805dbbde-05c8-4644-b916-7e7c1a3672c7",
      "keyValues" : [ {
        "key" : "editable",
        "value" : false
      } ],
      "concept" : {
        "name" : "Weight",
        "uuid" : "8b187dda-a88e-487a-981a-0e4cb6142904",
        "dataType" : "Numeric",
        "answers" : [ ],
        "lowAbsolute" : 1.0,
        "highAbsolute" : 100.0,
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 3.0,
      "type" : "SingleSelect",
      "rule" : "'use strict';\n({params, imports}) => {\n    const programEncounter = params.entity;\n    const moment = imports.moment;\n    const formElement = params.formElement;\n    const _ = imports.lodash;\n    let visibility = true;\n    let value = null;\n    let answersToSkip = [];\n    let validationErrors = [];\n\n    let obs = programEncounter.programEnrolment.findLatestObservationFromEncounters('Weight');\n\n    if (obs && obs !== undefined) {\n        value = obs.getReadableValue()\n    }\n\n    return new imports.rulesConfig.FormElementStatus(formElement.uuid, visibility, value, answersToSkip, validationErrors);\n};",
      "mandatory" : false
    }, {
      "name" : "Height",
      "uuid" : "64a239bf-6612-41db-b3c5-e5683268290a",
      "keyValues" : [ {
        "key" : "editable",
        "value" : false
      } ],
      "concept" : {
        "name" : "Height",
        "uuid" : "346902c4-9938-4ba5-90d1-587f36f1ab92",
        "dataType" : "Numeric",
        "answers" : [ ],
        "lowAbsolute" : 40.0,
        "highAbsolute" : 150.0,
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 4.0,
      "type" : "SingleSelect",
      "rule" : "'use strict';\n({params, imports}) => {\n    const programEncounter = params.entity;\n    const moment = imports.moment;\n    const formElement = params.formElement;\n    const _ = imports.lodash;\n    let visibility = true;\n    let value = null;\n    let answersToSkip = [];\n    let validationErrors = [];\n\n    let obs = programEncounter.programEnrolment.findLatestObservationFromEncounters('Height');\n    if (obs && obs !== undefined) {\n        value = obs.getReadableValue()\n    }\n    return new imports.rulesConfig.FormElementStatus(formElement.uuid, visibility, value, answersToSkip, validationErrors);\n};",
      "mandatory" : false
    }, {
      "name" : "Is the child receiving aditional THR in current month?",
      "uuid" : "566c10be-a718-45dd-bda5-6bc99277c6da",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Is the child receiving aditional THR in current month",
        "uuid" : "8da2b0c2-787b-4d15-a28c-36b163342960",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "Yes",
          "uuid" : "8ebbf088-f292-483e-9084-7de919ce67b7",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 0.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "No",
          "uuid" : "a77bd700-1409-4d52-93bc-9fe32c0e169b",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 5.0,
      "type" : "SingleSelect",
      "rule" : "'use strict';\n({params, imports}) => {\n  const programEncounter = params.entity;\n  const moment = imports.moment;\n  const formElement = params.formElement;\n  const _ = imports.lodash;\n  let visibility = true;\n  let value = null;\n  let answersToSkip = [];\n  let validationErrors = [];\n  \n  const oldDate = moment(programEncounter.maxVisitDateTime);\n  const currentDate = moment();\n  \n  if (currentDate.isAfter(oldDate)) {\n    validationErrors.push(\"Overdue forms cannot be filled, please cancel this form so that next due form can be scheduled\");\n  }\n\n  return new imports.rulesConfig.FormElementStatus(formElement.uuid, visibility, value, answersToSkip, validationErrors);\n};",
      "mandatory" : false
    }, {
      "name" : "Linked with social sector scheme",
      "uuid" : "e40780fa-8719-4e63-b68b-5187097e0d86",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Linked with social sector scheme",
        "uuid" : "0d9afcaf-f260-4a19-8cfe-115bd23d8c97",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "No",
          "uuid" : "a77bd700-1409-4d52-93bc-9fe32c0e169b",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Yes",
          "uuid" : "8ebbf088-f292-483e-9084-7de919ce67b7",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 0.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 6.0,
      "type" : "SingleSelect",
      "voided" : true,
      "mandatory" : true
    }, {
      "name" : "Is there any medical complication?",
      "uuid" : "96537a81-dfa1-4dc7-b287-0a1016e2ad8c",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Is there any medical complication",
        "uuid" : "75bbc352-b805-4245-b1a6-9f78f8845611",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "No",
          "uuid" : "a77bd700-1409-4d52-93bc-9fe32c0e169b",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Yes",
          "uuid" : "8ebbf088-f292-483e-9084-7de919ce67b7",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 0.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 7.0,
      "type" : "SingleSelect",
      "mandatory" : true
    }, {
      "name" : "Specify the medical complication",
      "uuid" : "6de48295-70e0-4f3c-ad72-2b34c5b93af0",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Medical complication",
        "uuid" : "ca2668f7-4532-4115-81d9-1c2a4a4eacdd",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "Diarrhoea",
          "uuid" : "e8bedb2b-c9fc-4c05-a0fe-a5d58d449824",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 0.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Fever",
          "uuid" : "e52444ff-f514-4dfb-835c-86925d0d8d50",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Vomitting",
          "uuid" : "45caaf3b-2664-4912-9fb2-9202e067814a",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 2.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Others",
          "uuid" : "caf114c0-b81a-4606-8157-73144c8d3b1f",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 4.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Breathing difficulty",
          "uuid" : "ea01e2e8-36d0-47f9-9e5d-c5b4abde1d10",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 3.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 8.0,
      "type" : "MultiSelect",
      "rule" : "'use strict';\n({params, imports}) => {\n  const programEncounter = params.entity;\n  const moment = imports.moment;\n  const formElement = params.formElement;\n  const _ = imports.lodash;\n  let visibility = true;\n  let value = null;\n  let answersToSkip = [];\n  let validationErrors = [];\n  \n  const condition11 = new imports.rulesConfig.RuleCondition({programEncounter, formElement}).when.valueInEncounter(\"75bbc352-b805-4245-b1a6-9f78f8845611\").containsAnswerConceptName(\"8ebbf088-f292-483e-9084-7de919ce67b7\").matches();\n  \n  visibility = condition11 ;\n  \n  return new imports.rulesConfig.FormElementStatus(formElement.uuid, visibility, value, answersToSkip, validationErrors);\n};",
      "declarativeRule" : [ {
        "actions" : [ {
          "actionType" : "showFormElement"
        }, { } ],
        "conditions" : [ {
          "compoundRule" : {
            "rules" : [ {
              "lhs" : {
                "type" : "concept",
                "scope" : "encounter",
                "conceptName" : "Is there any medical complication",
                "conceptUuid" : "75bbc352-b805-4245-b1a6-9f78f8845611",
                "conceptDataType" : "Coded"
              },
              "rhs" : {
                "type" : "answerConcept",
                "answerConceptNames" : [ "Yes" ],
                "answerConceptUuids" : [ "8ebbf088-f292-483e-9084-7de919ce67b7" ]
              },
              "operator" : "containsAnswerConceptName"
            } ]
          }
        } ]
      } ],
      "mandatory" : true
    }, {
      "name" : "Specify, the other medical complications",
      "uuid" : "d3c8b344-1446-4ee4-8a5d-46735b8f074a",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Specify other medical complications",
        "uuid" : "7c71119c-cced-4439-b019-19e735155ae4",
        "dataType" : "Text",
        "answers" : [ ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 9.0,
      "type" : "SingleSelect",
      "rule" : "'use strict';\n({params, imports}) => {\n  const programEncounter = params.entity;\n  const moment = imports.moment;\n  const formElement = params.formElement;\n  const _ = imports.lodash;\n  let visibility = true;\n  let value = null;\n  let answersToSkip = [];\n  let validationErrors = [];\n  \n  const condition11 = new imports.rulesConfig.RuleCondition({programEncounter, formElement}).when.valueInEncounter(\"ca2668f7-4532-4115-81d9-1c2a4a4eacdd\").containsAnswerConceptName(\"caf114c0-b81a-4606-8157-73144c8d3b1f\").matches();\n  \n  visibility = condition11 ;\n  \n  return new imports.rulesConfig.FormElementStatus(formElement.uuid, visibility, value, answersToSkip, validationErrors);\n};",
      "declarativeRule" : [ {
        "actions" : [ {
          "actionType" : "showFormElement"
        }, { } ],
        "conditions" : [ {
          "compoundRule" : {
            "rules" : [ {
              "lhs" : {
                "type" : "concept",
                "scope" : "encounter",
                "conceptName" : "Medical complication",
                "conceptUuid" : "ca2668f7-4532-4115-81d9-1c2a4a4eacdd",
                "conceptDataType" : "Coded"
              },
              "rhs" : {
                "type" : "answerConcept",
                "answerConceptNames" : [ "Others" ],
                "answerConceptUuids" : [ "caf114c0-b81a-4606-8157-73144c8d3b1f" ]
              },
              "operator" : "containsAnswerConceptName"
            } ],
            "conjunction" : "and"
          }
        } ]
      } ],
      "mandatory" : true
    }, {
      "name" : "Could you counsel the mother?",
      "uuid" : "c0520aaf-6d91-4007-a7dc-00c10055d6d1",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Could you counsel the mother",
        "uuid" : "02e5b282-59c7-403f-9bf4-b5972be4b533",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "No",
          "uuid" : "a77bd700-1409-4d52-93bc-9fe32c0e169b",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Yes",
          "uuid" : "8ebbf088-f292-483e-9084-7de919ce67b7",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 0.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 10.0,
      "type" : "SingleSelect",
      "mandatory" : true
    }, {
      "name" : "What are the parameters the women was counselled?",
      "uuid" : "b0d77d39-2528-43a0-bcc3-39fe03c019ca",
      "keyValues" : [ ],
      "concept" : {
        "name" : "What are the parameters the women was counselled",
        "uuid" : "677fc828-f086-43d3-930e-1ba4b647d7b1",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "Supplementary packets/Augmented THR",
          "uuid" : "3981c9f8-0ad4-4be3-8f90-4afc46f4f25b",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 3.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Any Medical conditions",
          "uuid" : "ed54d020-ae60-4518-be47-c4c1a386c231",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 4.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Meal frequency",
          "uuid" : "c472f507-7d61-46a3-91c6-c7cfa4f5c42f",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 0.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Handwashing and Hygiene",
          "uuid" : "468b33f4-47d0-4cf7-8db7-44cdfb7123c9",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 5.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Dietary diversity",
          "uuid" : "62db5ed2-1743-4aab-ac4b-09ae2666f280",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 2.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "Minimum number of meals",
          "uuid" : "c4983e0a-ff29-47a2-9f05-6162bad339b7",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 11.0,
      "type" : "MultiSelect",
      "rule" : "'use strict';\n({params, imports}) => {\n  const programEncounter = params.entity;\n  const moment = imports.moment;\n  const formElement = params.formElement;\n  const _ = imports.lodash;\n  let visibility = true;\n  let value = null;\n  let answersToSkip = [];\n  let validationErrors = [];\n  \n  const condition11 = new imports.rulesConfig.RuleCondition({programEncounter, formElement}).when.valueInEncounter(\"02e5b282-59c7-403f-9bf4-b5972be4b533\").containsAnswerConceptName(\"8ebbf088-f292-483e-9084-7de919ce67b7\").matches();\n  \n  visibility = condition11 ;\n  \n  return new imports.rulesConfig.FormElementStatus(formElement.uuid, visibility, value, answersToSkip, validationErrors);\n};",
      "declarativeRule" : [ {
        "actions" : [ {
          "actionType" : "showFormElement"
        }, { } ],
        "conditions" : [ {
          "compoundRule" : {
            "rules" : [ {
              "lhs" : {
                "type" : "concept",
                "scope" : "encounter",
                "conceptName" : "Could you counsel the mother",
                "conceptUuid" : "02e5b282-59c7-403f-9bf4-b5972be4b533",
                "conceptDataType" : "Coded"
              },
              "rhs" : {
                "type" : "answerConcept",
                "answerConceptNames" : [ "Yes" ],
                "answerConceptUuids" : [ "8ebbf088-f292-483e-9084-7de919ce67b7" ]
              },
              "operator" : "containsAnswerConceptName"
            } ],
            "conjunction" : "and"
          }
        } ]
      } ],
      "mandatory" : true
    }, {
      "name" : "Is any health worker accompanying you?",
      "uuid" : "ca7283c9-42d5-4d04-9e36-bab80d1523aa",
      "keyValues" : [ ],
      "concept" : {
        "name" : "Is any health worker accompanying you?",
        "uuid" : "dc4cfecb-9bbf-4e92-8ee6-2bf42a3b67ce",
        "dataType" : "Coded",
        "answers" : [ {
          "name" : "ASHA",
          "uuid" : "b738ce8f-ada1-4de2-abcc-a602513c75f5",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 2.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "None",
          "uuid" : "d1a185a8-c116-4b20-a37f-2deb03ed9654",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 3.0,
          "unique" : true,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "AWW",
          "uuid" : "7b607352-bab1-4fd3-bd6b-5ca748654e03",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 1.0,
          "active" : true,
          "media" : [ ]
        }, {
          "name" : "ANM",
          "uuid" : "6b3f25b4-5b76-4b00-b967-efffa2345d83",
          "dataType" : "NA",
          "answers" : [ ],
          "order" : 0.0,
          "active" : true,
          "media" : [ ]
        } ],
        "active" : true,
        "media" : [ ]
      },
      "displayOrder" : 12.0,
      "type" : "MultiSelect",
      "mandatory" : true
    } ],
    "display" : "Details",
    "timed" : false
  } ],
  "decisionRule" : "",
  "visitScheduleRule" : "\"use strict\";\n({params, imports}) => {\n    const programEncounter = params.entity;\n    const programEnrolment = programEncounter.programEnrolment;\n    const moment = imports.moment;\n    const scheduleBuilder = new imports.rulesConfig.VisitScheduleBuilder({programEncounter});\n\n    function isVisitAlreadyScheduled(earliestDate, encounterType, encounterName) {\n      const earliestVisitDateTime = moment(earliestDate);\n      return programEnrolment.encounters.some(enc => \n        enc.encounterType.name === encounterType && \n        enc.name === encounterName &&\n        moment(enc.earliestVisitDateTime).isSame(earliestVisitDateTime, 'day')\n      );\n    }\n\n    function getChildHomeVisitDate(qrtEncounterDate) {\n      const intervalInDays = moment(programEncounter.earliestVisitDateTime).diff(moment(qrtEncounterDate), 'days');\n\n      let daysToAdd = 0;\n      if (intervalInDays <= 15) {\n        daysToAdd = 30;\n      } else if (intervalInDays <= 30) {\n        daysToAdd = 45;\n      } else if (intervalInDays <= 45) {\n        daysToAdd = 60;\n      }\n\n      return daysToAdd !== 0 ? moment(qrtEncounterDate).add(daysToAdd, 'days').toDate() : null;\n    }\n\n    function lastfilledEncounter(encounterType) {\n      const lastVisitEncounters = programEncounter.programEnrolment.getEncountersOfType(encounterType, false);\n      const latestEncounter = _.chain(lastVisitEncounters)\n        .filter((encounter) => encounter.encounterDateTime && encounter.voided == false)\n        .maxBy((encounter) => encounter.encounterDateTime)\n        .value();\n      return latestEncounter;\n    }\n\n    const qrtEncounter = lastfilledEncounter('QRT Child');\n    if (qrtEncounter && programEncounter.name != 'Child Home Visit - Post NRC') {\n      const qrtEncounterDate = qrtEncounter ? moment(qrtEncounter.encounterDateTime).toDate() : null;\n      const visitDate = getChildHomeVisitDate(qrtEncounterDate);\n      const takenToMedicalFacility = qrtEncounter.getObservationReadableValue(\"QRT facilitated child to medical facility?\") == \"Yes\";\n      const latestGMEncounter = lastfilledEncounter('Growth Monitoring');\n      const isSAMInLatestGMEncounter = latestGMEncounter.getObservationReadableValue(\"Nutritional Status\") == \"SAM\";\n      const isGF1InLatestGMEncounter = latestGMEncounter.getObservationReadableValue(\"Growth Faltering\") == \"GF1\";\n              \n      if ((takenToMedicalFacility || isSAMInLatestGMEncounter || !isGF1InLatestGMEncounter ) && !_.isNil(visitDate)) { \n        scheduleBuilder.add({\n          name: 'Child Home Visit',\n          encounterType: 'Child Home Visit',\n          earliestDate: moment(visitDate).startOf('day').toDate(),\n          maxDate: moment(visitDate).add(7, 'days').endOf('day').toDate(),\n          visitCreationStrategy: \"createNew\"\n        });\n      }\n    }\n    \n    if (programEncounter.name == 'Child Home Visit - Post NRC'){\n      const nrcEncounter = lastfilledEncounter('NRC Discharge');\n      if(nrcEncounter) {\n        const nrcDischargeDate = nrcEncounter ? moment(nrcEncounter.getObservationReadableValue('71e84ef3-4f1d-4814-84fc-3672b3a72423')).toDate() : null;\n        const visitDate = getChildHomeVisitDate(nrcDischargeDate);\n        \n        if (!_.isNil(visitDate) && !isVisitAlreadyScheduled(visitDate, 'Child Home Visit', 'Child Home Visit - Post NRC')) { \n          scheduleBuilder.add({\n            name: 'Child Home Visit - Post NRC',\n            encounterType: 'Child Home Visit',\n            earliestDate: moment(visitDate).startOf('day').toDate(),\n            maxDate: moment(visitDate).add(7, 'days').endOf('day').toDate(),\n            visitCreationStrategy: \"createNew\"\n          });\n        }\n      }\n    }\n    \n    const earliestDate = moment(programEncounter.encounterDateTime);\n    const latestGMEncounter = lastfilledEncounter('Growth Monitoring');\n    const isSAMInLatestGMEncounter = latestGMEncounter.getObservationReadableValue(\"Nutritional Status\") == \"SAM\";\n    const isMAMInLatestGMEncounter = latestGMEncounter.getObservationReadableValue(\"Nutritional Status\") == \"MAM\";\n    const isGF2InLatestGMEncounter = latestGMEncounter.getObservationReadableValue(\"Growth Faltering\") == \"GF2\";\n    const currentlyActiveInProgram = !programEncounter.programEnrolment.programExitDateTime;\n    const supervisorChildEncounter = lastfilledEncounter('Supervisor Child Home visit');\n    let schEncounterDate;\n    let schEncounterMonth;\n    if (supervisorChildEncounter) {\n        schEncounterDate = imports.moment(supervisorChildEncounter.encounterDateTime).toDate();\n        schEncounterMonth = imports.moment(schEncounterDate).month();\n    }      \n    const earliestDateMonth = earliestDate.month();\n\n    \n    let isAlreadyScheduled = programEncounter.programEnrolment.encounters.some((enc) =>\n        enc.encounterType.name === 'Supervisor Child Home visit' &&\n        enc.voided === false &&\n        moment(enc.earliestVisitDateTime).isSame(earliestDate, 'day')\n    );\n\n    if((schEncounterMonth !== earliestDateMonth) && !isAlreadyScheduled && currentlyActiveInProgram && (isSAMInLatestGMEncounter || isMAMInLatestGMEncounter || isGF2InLatestGMEncounter)) {\n        scheduleBuilder.add({\n            name: 'Supervisor Child Home visit',\n            encounterType: 'Supervisor Child Home visit',\n            earliestDate: earliestDate.startOf('day').toDate(),\n            maxDate:  earliestDate.endOf('month').toDate()\n        });\n    }\n    return scheduleBuilder.getAll();\n};",
  "validationRule" : "'use strict';\n({params, imports}) => {\n  const programEncounter = params.entity;\n  const moment = imports.moment;\n  const validationResults = [];\n  \n  const isMaxVisitDateTimeGreaterThanToday = moment(programEncounter.maxVisitDateTime).isBefore(moment(), 'day');\n\n  if (isMaxVisitDateTimeGreaterThanToday) {\n    validationResults.push(imports.common.createValidationError(\"You cannot complete an overdue visit. Please cancel this visit.\"));  \n  }\n     // Get schedule date (earliest visit date)\n    const scheduleDate = programEncounter.earliestVisitDateTime;\n  \n    // Check if encounter date is before schedule month\n    const isBeforeScheduleMonth = moment(programEncounter.encounterDateTime)\n        .isBefore(moment(scheduleDate));\n\n    // Check if encounter date is after schedule month\n    const isAfterScheduleMonth = moment(programEncounter.encounterDateTime)\n        .isAfter(moment(scheduleDate).endOf('month'));\n\n    if (isBeforeScheduleMonth) {\n        validationResults.push(imports.common.createValidationError(\"Cannot fill this form before the scheduled date\"));\n    }\n\n    \n  \n  \n  return validationResults;\n};",
  "checklistsRule" : "",
  "decisionConcepts" : [ ]
}